<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Chief of Staff — Organizational Intelligence</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link href="https://fonts.googleapis.com/css2?family=Newsreader:ital,opsz,wght@0,6..72,300;0,6..72,500;0,6..72,700;1,6..72,300&family=Outfit:wght@300;400;500;600;700&family=JetBrains+Mono:wght@400;500;600&display=swap" rel="stylesheet">
  <style>
    :root {
      --bg: #05080f;
      --surface: #0a1020;
      --surface-2: #111a2e;
      --surface-3: #182240;
      --border: rgba(0, 229, 255, 0.07);
      --border-strong: rgba(0, 229, 255, 0.15);
      --text: #d0d8e8;
      --text-muted: #5a6880;
      --text-dim: #3a4a60;
      --accent: #00e5ff;
      --accent-dim: rgba(0, 229, 255, 0.08);
      --accent-glow: rgba(0, 229, 255, 0.2);
      --danger: #ff4757;

      --c-person: #ff6b9d;
      --c-project: #00e5ff;
      --c-topic: #c084fc;
      --c-decision: #fb923c;
      --c-insight: #4ade80;
      --c-goal: #fbbf24;
      --c-team: #818cf8;
      --c-default: #5a6880;

      --font-display: 'Newsreader', Georgia, serif;
      --font-body: 'Outfit', system-ui, sans-serif;
      --font-mono: 'JetBrains Mono', monospace;
    }

    *, *::before, *::after { margin: 0; padding: 0; box-sizing: border-box; }

    html, body { height: 100%; overflow: hidden; }

    body {
      font-family: var(--font-body);
      background: var(--bg);
      color: var(--text);
    }

    /* ── App Layout ── */
    .app {
      display: grid;
      grid-template-rows: 52px 1fr 40px;
      grid-template-columns: 1fr 420px;
      height: 100vh;
    }

    /* ── Top Bar ── */
    .topbar {
      grid-column: 1 / -1;
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 0 24px;
      background: linear-gradient(180deg, rgba(10, 16, 32, 0.98), rgba(10, 16, 32, 0.85));
      backdrop-filter: blur(20px);
      border-bottom: 1px solid var(--border);
      z-index: 100;
    }

    .topbar-left {
      display: flex;
      align-items: center;
      gap: 16px;
    }

    .logo {
      display: flex;
      align-items: center;
      gap: 10px;
    }

    .logo-mark {
      width: 28px;
      height: 28px;
      border-radius: 8px;
      background: linear-gradient(135deg, var(--accent), #0090a8);
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 14px;
      font-weight: 700;
      color: var(--bg);
      box-shadow: 0 0 20px rgba(0, 229, 255, 0.3);
    }

    .logo-text {
      font-family: var(--font-display);
      font-size: 17px;
      font-weight: 500;
      letter-spacing: -0.01em;
      color: var(--text);
    }

    .logo-text em {
      font-style: italic;
      color: var(--accent);
      font-weight: 300;
    }

    .live-badge {
      display: flex;
      align-items: center;
      gap: 6px;
      font-family: var(--font-mono);
      font-size: 10px;
      font-weight: 600;
      letter-spacing: 0.08em;
      text-transform: uppercase;
      color: var(--accent);
      padding: 3px 10px;
      border-radius: 4px;
      background: var(--accent-dim);
      border: 1px solid rgba(0, 229, 255, 0.12);
    }

    .live-dot {
      width: 6px;
      height: 6px;
      border-radius: 50%;
      background: var(--accent);
      animation: pulse-dot 2s ease-in-out infinite;
    }

    @keyframes pulse-dot {
      0%, 100% { opacity: 1; box-shadow: 0 0 0 0 rgba(0, 229, 255, 0.4); }
      50% { opacity: 0.6; box-shadow: 0 0 0 4px rgba(0, 229, 255, 0); }
    }

    .topbar-stats {
      display: flex;
      gap: 24px;
      font-family: var(--font-mono);
      font-size: 12px;
      color: var(--text-muted);
    }

    .topbar-stats strong {
      color: var(--text);
      font-weight: 600;
    }

    /* ── Graph Area ── */
    .graph-area {
      position: relative;
      overflow: hidden;
      background:
        radial-gradient(ellipse at 40% 50%, rgba(0, 229, 255, 0.03) 0%, transparent 60%),
        radial-gradient(ellipse at 70% 30%, rgba(129, 140, 248, 0.02) 0%, transparent 50%),
        var(--bg);
    }

    .graph-area svg {
      width: 100%;
      height: 100%;
      display: block;
    }

    .graph-controls {
      position: absolute;
      bottom: 16px;
      left: 16px;
      display: flex;
      flex-direction: column;
      gap: 2px;
    }

    .graph-controls button {
      width: 32px;
      height: 32px;
      border: 1px solid var(--border);
      background: rgba(10, 16, 32, 0.9);
      backdrop-filter: blur(8px);
      color: var(--text-muted);
      border-radius: 6px;
      cursor: pointer;
      font-size: 16px;
      display: flex;
      align-items: center;
      justify-content: center;
      transition: all 0.15s;
    }

    .graph-controls button:hover {
      background: var(--surface-2);
      color: var(--text);
      border-color: var(--border-strong);
    }

    /* Legend overlay */
    .legend {
      position: absolute;
      top: 12px;
      left: 12px;
      display: flex;
      gap: 12px;
      flex-wrap: wrap;
      padding: 8px 12px;
      background: rgba(10, 16, 32, 0.85);
      backdrop-filter: blur(12px);
      border: 1px solid var(--border);
      border-radius: 8px;
    }

    .legend-item {
      display: flex;
      align-items: center;
      gap: 5px;
      font-size: 11px;
      color: var(--text-muted);
      font-weight: 500;
    }

    .legend-dot {
      width: 8px;
      height: 8px;
      border-radius: 50%;
    }

    /* ── Sidebar ── */
    .sidebar {
      display: flex;
      flex-direction: column;
      background: var(--surface);
      border-left: 1px solid var(--border);
      overflow: hidden;
    }

    .sidebar-tabs {
      display: flex;
      border-bottom: 1px solid var(--border);
      flex-shrink: 0;
    }

    .sidebar-tab {
      flex: 1;
      padding: 12px 0;
      font-family: var(--font-mono);
      font-size: 11px;
      font-weight: 600;
      letter-spacing: 0.04em;
      text-transform: uppercase;
      text-align: center;
      color: var(--text-muted);
      background: none;
      border: none;
      cursor: pointer;
      transition: all 0.2s;
      position: relative;
    }

    .sidebar-tab:hover { color: var(--text); }

    .sidebar-tab.active {
      color: var(--accent);
    }

    .sidebar-tab.active::after {
      content: '';
      position: absolute;
      bottom: 0;
      left: 20%;
      right: 20%;
      height: 2px;
      background: var(--accent);
      border-radius: 1px;
    }

    .sidebar-content {
      flex: 1;
      overflow-y: auto;
      scrollbar-width: thin;
      scrollbar-color: var(--surface-3) transparent;
    }

    .tab-panel { display: none; height: 100%; }
    .tab-panel.active { display: flex; flex-direction: column; }

    /* ── Explore Panel ── */
    .explore-empty {
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      height: 100%;
      gap: 12px;
      padding: 40px;
      text-align: center;
    }

    .explore-empty-icon {
      font-size: 36px;
      opacity: 0.3;
    }

    .explore-empty p {
      font-size: 14px;
      color: var(--text-muted);
      line-height: 1.6;
    }

    .node-detail { padding: 20px; }

    .node-detail-header {
      margin-bottom: 16px;
    }

    .node-detail-name {
      font-family: var(--font-display);
      font-size: 22px;
      font-weight: 700;
      letter-spacing: -0.02em;
      line-height: 1.2;
      margin-bottom: 8px;
    }

    .node-type-badge {
      display: inline-flex;
      align-items: center;
      gap: 5px;
      font-family: var(--font-mono);
      font-size: 11px;
      font-weight: 600;
      padding: 3px 10px;
      border-radius: 5px;
      letter-spacing: 0.02em;
    }

    .node-tags {
      display: flex;
      flex-wrap: wrap;
      gap: 5px;
      margin-top: 10px;
    }

    .node-tag {
      font-size: 11px;
      font-weight: 500;
      padding: 2px 8px;
      border-radius: 4px;
      background: rgba(90, 104, 128, 0.12);
      color: var(--text-muted);
      border: 1px solid rgba(90, 104, 128, 0.1);
    }

    .node-content {
      font-size: 14px;
      line-height: 1.75;
      color: var(--text-muted);
      white-space: pre-wrap;
      word-wrap: break-word;
      margin-bottom: 20px;
    }

    .wikilink {
      color: var(--accent);
      cursor: pointer;
      border-bottom: 1px dashed rgba(0, 229, 255, 0.25);
      transition: all 0.15s;
    }

    .wikilink:hover {
      border-bottom-style: solid;
      text-shadow: 0 0 8px rgba(0, 229, 255, 0.3);
    }

    .links-section {
      padding-top: 16px;
      border-top: 1px solid var(--border);
      margin-bottom: 16px;
    }

    .links-label {
      font-family: var(--font-mono);
      font-size: 10px;
      font-weight: 600;
      letter-spacing: 0.06em;
      text-transform: uppercase;
      color: var(--text-dim);
      margin-bottom: 8px;
    }

    .links-list {
      display: flex;
      flex-wrap: wrap;
      gap: 5px;
    }

    .link-chip {
      font-size: 12px;
      font-weight: 500;
      padding: 3px 10px;
      border-radius: 6px;
      cursor: pointer;
      transition: all 0.15s;
      background: var(--accent-dim);
      color: var(--accent);
      border: 1px solid rgba(0, 229, 255, 0.1);
    }

    .link-chip:hover {
      background: rgba(0, 229, 255, 0.18);
      border-color: rgba(0, 229, 255, 0.25);
    }

    .node-meta {
      font-family: var(--font-mono);
      font-size: 10px;
      color: var(--text-dim);
      margin-top: 12px;
    }

    /* ── Ask Panel ── */
    .ask-panel {
      padding: 20px;
      gap: 16px;
    }

    .ask-panel h3 {
      font-family: var(--font-display);
      font-size: 16px;
      font-weight: 500;
      color: var(--text);
      margin-bottom: 4px;
    }

    .ask-roles {
      display: flex;
      gap: 6px;
      flex-wrap: wrap;
    }

    .role-chip {
      font-size: 12px;
      font-weight: 500;
      padding: 5px 12px;
      border-radius: 6px;
      cursor: pointer;
      border: 1px solid var(--border);
      background: transparent;
      color: var(--text-muted);
      transition: all 0.15s;
      font-family: var(--font-body);
    }

    .role-chip:hover {
      border-color: var(--border-strong);
      color: var(--text);
    }

    .role-chip.active {
      background: var(--accent-dim);
      border-color: rgba(0, 229, 255, 0.2);
      color: var(--accent);
    }

    .ask-input-group { position: relative; }

    .ask-textarea {
      width: 100%;
      min-height: 80px;
      padding: 12px 14px;
      border: 1px solid var(--border);
      border-radius: 10px;
      background: var(--bg);
      color: var(--text);
      font-family: var(--font-body);
      font-size: 14px;
      line-height: 1.5;
      resize: vertical;
      outline: none;
      transition: border-color 0.2s;
    }

    .ask-textarea::placeholder { color: var(--text-dim); }
    .ask-textarea:focus { border-color: rgba(0, 229, 255, 0.3); }

    .ask-submit {
      width: 100%;
      padding: 10px;
      border: none;
      border-radius: 8px;
      background: linear-gradient(135deg, var(--accent), #0090a8);
      color: var(--bg);
      font-family: var(--font-body);
      font-size: 14px;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.2s;
      letter-spacing: 0.01em;
    }

    .ask-submit:hover { opacity: 0.9; transform: translateY(-1px); }
    .ask-submit:active { transform: translateY(0); }
    .ask-submit:disabled { opacity: 0.5; cursor: not-allowed; transform: none; }

    .ask-answer {
      flex: 1;
      overflow-y: auto;
      padding: 16px;
      margin-top: 8px;
      background: var(--bg);
      border: 1px solid var(--border);
      border-radius: 10px;
      font-size: 14px;
      line-height: 1.75;
      color: var(--text-muted);
      white-space: pre-wrap;
      word-wrap: break-word;
    }

    .ask-answer:empty { display: none; }

    /* ── Ingest Panel ── */
    .ingest-panel {
      padding: 20px;
      gap: 12px;
    }

    .ingest-panel h3 {
      font-family: var(--font-display);
      font-size: 16px;
      font-weight: 500;
      color: var(--text);
    }

    .sample-btn {
      font-size: 12px;
      padding: 5px 12px;
      border-radius: 6px;
      border: 1px dashed var(--border-strong);
      background: transparent;
      color: var(--text-muted);
      cursor: pointer;
      font-family: var(--font-body);
      transition: all 0.15s;
    }

    .sample-btn:hover {
      border-style: solid;
      background: var(--accent-dim);
      color: var(--accent);
    }

    .ingest-result {
      padding: 12px;
      background: var(--bg);
      border: 1px solid var(--border);
      border-radius: 8px;
      font-size: 13px;
      line-height: 1.6;
      color: var(--text-muted);
    }

    .ingest-result:empty { display: none; }

    .ingest-result .created {
      color: var(--c-insight);
      font-weight: 600;
    }

    .ingest-result .updated {
      color: var(--c-decision);
      font-weight: 600;
    }

    /* ── Scenarios (Onboard / Conflicts) ── */
    .scenarios {
      margin-top: auto;
      padding: 16px 20px;
      border-top: 1px solid var(--border);
    }

    .scenarios-title {
      font-family: var(--font-mono);
      font-size: 10px;
      font-weight: 600;
      letter-spacing: 0.06em;
      text-transform: uppercase;
      color: var(--text-dim);
      margin-bottom: 8px;
    }

    .scenario-btn {
      display: block;
      width: 100%;
      padding: 8px 12px;
      margin-bottom: 6px;
      border: 1px solid var(--border);
      border-radius: 8px;
      background: transparent;
      color: var(--text-muted);
      font-family: var(--font-body);
      font-size: 13px;
      text-align: left;
      cursor: pointer;
      transition: all 0.15s;
    }

    .scenario-btn:hover {
      background: var(--accent-dim);
      border-color: var(--border-strong);
      color: var(--text);
    }

    .scenario-btn strong {
      color: var(--text);
      font-weight: 600;
    }

    /* ── Status Bar ── */
    .statusbar {
      grid-column: 1 / -1;
      display: flex;
      align-items: center;
      padding: 0 16px;
      gap: 16px;
      background: var(--surface);
      border-top: 1px solid var(--border);
      font-family: var(--font-mono);
      font-size: 11px;
      color: var(--text-dim);
    }

    .statusbar-activity {
      flex: 1;
      overflow: hidden;
      text-overflow: ellipsis;
      white-space: nowrap;
    }

    .statusbar-activity .highlight {
      color: var(--accent);
      font-weight: 600;
    }

    /* ── Loading / Processing States ── */
    .processing {
      display: flex;
      align-items: center;
      gap: 10px;
      padding: 12px;
      border-radius: 8px;
      background: var(--accent-dim);
      border: 1px solid rgba(0, 229, 255, 0.1);
      font-size: 13px;
      color: var(--accent);
    }

    .spinner {
      width: 16px;
      height: 16px;
      border: 2px solid rgba(0, 229, 255, 0.2);
      border-top-color: var(--accent);
      border-radius: 50%;
      animation: spin 0.8s linear infinite;
    }

    @keyframes spin { to { transform: rotate(360deg); } }

    /* ── Tooltip ── */
    .tooltip {
      position: fixed;
      pointer-events: none;
      padding: 6px 12px;
      background: rgba(10, 16, 32, 0.95);
      border: 1px solid var(--border-strong);
      border-radius: 6px;
      font-size: 12px;
      font-weight: 500;
      color: var(--text);
      opacity: 0;
      transition: opacity 0.12s;
      z-index: 1000;
      backdrop-filter: blur(8px);
    }

    .tooltip.visible { opacity: 1; }

    /* ── Entry Animation ── */
    @keyframes fade-in-up {
      from { opacity: 0; transform: translateY(8px); }
      to { opacity: 1; transform: translateY(0); }
    }

    .animate-in {
      animation: fade-in-up 0.4s ease-out both;
    }

    /* ── Node highlight ── */
    @keyframes node-pop {
      0% { r: 0; opacity: 0; }
      60% { opacity: 1; }
      80% { r: attr(data-target-r); }
      100% { opacity: 1; }
    }

    /* ── Scrollbar ── */
    .sidebar-content::-webkit-scrollbar { width: 4px; }
    .sidebar-content::-webkit-scrollbar-track { background: transparent; }
    .sidebar-content::-webkit-scrollbar-thumb { background: var(--surface-3); border-radius: 2px; }
  </style>
</head>
<body>

<div class="app">
  <!-- Top Bar -->
  <header class="topbar">
    <div class="topbar-left">
      <div class="logo">
        <div class="logo-mark">AI</div>
        <div class="logo-text">Chief of <em>Staff</em></div>
      </div>
      <div class="live-badge">
        <span class="live-dot"></span>
        Live
      </div>
    </div>
    <div class="topbar-stats">
      <div><strong id="stat-nodes">0</strong> nodes</div>
      <div><strong id="stat-edges">0</strong> edges</div>
      <div><strong id="stat-types">0</strong> types</div>
    </div>
  </header>

  <!-- Graph -->
  <div class="graph-area">
    <svg id="graph-svg"></svg>
    <div class="legend" id="legend"></div>
    <div class="graph-controls">
      <button onclick="zoomIn()" title="Zoom in">+</button>
      <button onclick="zoomOut()" title="Zoom out">&minus;</button>
      <button onclick="resetZoom()" title="Reset view">&#8634;</button>
    </div>
  </div>

  <!-- Sidebar -->
  <aside class="sidebar">
    <nav class="sidebar-tabs">
      <button class="sidebar-tab active" data-tab="explore">Explore</button>
      <button class="sidebar-tab" data-tab="ask">Ask</button>
      <button class="sidebar-tab" data-tab="ingest">Ingest</button>
    </nav>
    <div class="sidebar-content">
      <!-- Explore Tab -->
      <div class="tab-panel active" id="tab-explore">
        <div class="explore-empty" id="explore-empty">
          <div class="explore-empty-icon">&#9673;</div>
          <p>Click a node on the graph to explore its knowledge, connections, and context.</p>
        </div>
        <div class="node-detail" id="node-detail" style="display:none"></div>
      </div>

      <!-- Ask Tab -->
      <div class="tab-panel" id="tab-ask">
        <div class="ask-panel">
          <h3>Ask the knowledge graph</h3>
          <div class="ask-roles" id="ask-roles">
            <button class="role-chip active" data-role="ceo">CEO</button>
            <button class="role-chip" data-role="engineer">Engineer</button>
            <button class="role-chip" data-role="pm">PM</button>
            <button class="role-chip" data-role="new-joiner">New Joiner</button>
          </div>
          <div class="ask-input-group">
            <textarea class="ask-textarea" id="ask-input" placeholder="What's the status of the Q2 launch?"></textarea>
          </div>
          <button class="ask-submit" id="ask-submit" onclick="submitQuery()">Ask</button>
          <div id="ask-loading" style="display:none">
            <div class="processing"><div class="spinner"></div>Traversing the knowledge graph...</div>
          </div>
          <div class="ask-answer" id="ask-answer"></div>

          <div class="scenarios">
            <div class="scenarios-title">Demo scenarios</div>
            <button class="scenario-btn" onclick="runScenario('ceo-status')">
              <strong>CEO Dashboard:</strong> "What changed this week?"
            </button>
            <button class="scenario-btn" onclick="runScenario('onboard')">
              <strong>New Joiner:</strong> "Bring me up to speed on everything"
            </button>
            <button class="scenario-btn" onclick="runScenario('conflict')">
              <strong>Conflict Detection:</strong> "Are there any contradictions?"
            </button>
            <button class="scenario-btn" onclick="runScenario('dependency')">
              <strong>Dependency Map:</strong> "What blocks the Q2 launch?"
            </button>
          </div>
        </div>
      </div>

      <!-- Ingest Tab -->
      <div class="tab-panel" id="tab-ingest">
        <div class="ingest-panel">
          <h3>Feed a new event</h3>
          <p style="font-size:13px;color:var(--text-muted);margin-bottom:4px">
            Paste a meeting note, Slack message, decision, or any organizational event.
            The AI will extract knowledge and update the graph.
          </p>
          <div style="display:flex;gap:6px;flex-wrap:wrap">
            <button class="sample-btn" onclick="loadSample('security')">Sample: Security finding</button>
            <button class="sample-btn" onclick="loadSample('hire')">Sample: New hire</button>
            <button class="sample-btn" onclick="loadSample('incident')">Sample: Incident</button>
          </div>
          <textarea class="ask-textarea" id="ingest-input" style="min-height:120px" placeholder="Paste an event here..."></textarea>
          <button class="ask-submit" id="ingest-submit" onclick="submitIngest()">Ingest Event</button>
          <div id="ingest-loading" style="display:none">
            <div class="processing"><div class="spinner"></div>AI is analyzing and updating the graph...</div>
          </div>
          <div class="ingest-result" id="ingest-result"></div>
        </div>
      </div>
    </div>
  </aside>

  <!-- Status Bar -->
  <div class="statusbar">
    <div class="statusbar-activity" id="statusbar">
      Ready — <span class="highlight">knowledge graph loaded</span>
    </div>
  </div>
</div>

<div class="tooltip" id="tooltip"></div>

<script src="https://d3js.org/d3.v7.min.js"></script>
<script>
// ── Configuration ──
const TYPE_COLORS = {
  person:   '#ff6b9d',
  project:  '#00e5ff',
  topic:    '#c084fc',
  decision: '#fb923c',
  insight:  '#4ade80',
  goal:     '#fbbf24',
  team:     '#818cf8',
};
const DEFAULT_COLOR = '#5a6880';
const color = type => TYPE_COLORS[type] || DEFAULT_COLOR;
const radius = d => Math.max(7, Math.min(22, 7 + (d.link_count || 0) * 1.8));

// ── State ──
let graphData = null;
let simulation = null;
let nodeEls, linkEls, labelEls, haloEls;
let zoomBehavior;
let selectedNode = null;
let activeRole = 'ceo';
let highlightedNodes = new Set();

// ── Legend ──
const legendEl = document.getElementById('legend');
Object.entries(TYPE_COLORS).forEach(([type, c]) => {
  const d = document.createElement('div');
  d.className = 'legend-item';
  d.innerHTML = `<div class="legend-dot" style="background:${c};box-shadow:0 0 6px ${c}60"></div>${type}`;
  legendEl.appendChild(d);
});

// ── Tabs ──
document.querySelectorAll('.sidebar-tab').forEach(tab => {
  tab.addEventListener('click', () => {
    document.querySelectorAll('.sidebar-tab').forEach(t => t.classList.remove('active'));
    document.querySelectorAll('.tab-panel').forEach(p => p.classList.remove('active'));
    tab.classList.add('active');
    document.getElementById('tab-' + tab.dataset.tab).classList.add('active');
  });
});

// ── Role chips ──
document.querySelectorAll('.role-chip').forEach(chip => {
  chip.addEventListener('click', () => {
    document.querySelectorAll('.role-chip').forEach(c => c.classList.remove('active'));
    chip.classList.add('active');
    activeRole = chip.dataset.role;
  });
});

// ── Tooltip ──
const tooltip = document.getElementById('tooltip');

// ── Graph Rendering ──
function renderGraph(data, opts = {}) {
  graphData = data;
  const animate = opts.animate !== false;
  const newNodeIds = new Set(opts.newNodes || []);
  const updatedNodeIds = new Set(opts.updatedNodes || []);

  // Update stats
  document.getElementById('stat-nodes').textContent = data.nodes.length;
  document.getElementById('stat-edges').textContent = data.links.length;
  const types = new Set(data.nodes.map(n => n.type));
  document.getElementById('stat-types').textContent = types.size;

  const svg = d3.select('#graph-svg');
  const rect = document.querySelector('.graph-area').getBoundingClientRect();
  const width = rect.width;
  const height = rect.height;

  svg.selectAll('*').remove();

  // SVG defs for glow effects
  const defs = svg.append('defs');
  Object.entries(TYPE_COLORS).forEach(([type, c]) => {
    const f = defs.append('filter').attr('id', `glow-${type}`).attr('x', '-50%').attr('y', '-50%').attr('width', '200%').attr('height', '200%');
    f.append('feGaussianBlur').attr('stdDeviation', 6).attr('result', 'blur');
    f.append('feFlood').attr('flood-color', c).attr('flood-opacity', 0.5);
    f.append('feComposite').attr('in2', 'blur').attr('operator', 'in');
    const m = f.append('feMerge');
    m.append('feMergeNode');
    m.append('feMergeNode').attr('in', 'SourceGraphic');
  });

  const g = svg.append('g');

  // Zoom
  zoomBehavior = d3.zoom()
    .scaleExtent([0.15, 4])
    .on('zoom', e => g.attr('transform', e.transform));
  svg.call(zoomBehavior);
  svg.call(zoomBehavior.transform,
    d3.zoomIdentity.translate(width / 2, height / 2).scale(0.85).translate(-width / 2, -height / 2));

  // Simulation
  simulation = d3.forceSimulation(data.nodes)
    .force('link', d3.forceLink(data.links).id(d => d.id).distance(90).strength(0.4))
    .force('charge', d3.forceManyBody().strength(-350))
    .force('center', d3.forceCenter(width / 2, height / 2))
    .force('collision', d3.forceCollide().radius(d => radius(d) + 8));

  // Edges
  linkEls = g.append('g')
    .selectAll('line')
    .data(data.links)
    .join('line')
    .attr('stroke', '#0d1a30')
    .attr('stroke-width', 1.2)
    .attr('opacity', animate ? 0 : 0.2);

  // Node halos (glow circles behind nodes)
  haloEls = g.append('g')
    .selectAll('circle')
    .data(data.nodes)
    .join('circle')
    .attr('r', d => radius(d) + 8)
    .attr('fill', d => color(d.type))
    .attr('opacity', 0);

  // Nodes
  nodeEls = g.append('g')
    .selectAll('circle')
    .data(data.nodes)
    .join('circle')
    .attr('r', d => animate ? 0 : radius(d))
    .attr('fill', d => color(d.type))
    .attr('stroke', d => color(d.type))
    .attr('stroke-width', 1.5)
    .attr('stroke-opacity', 0.25)
    .attr('filter', d => TYPE_COLORS[d.type] ? `url(#glow-${d.type})` : null)
    .attr('opacity', animate ? 0 : 1)
    .style('cursor', 'pointer')
    .on('mouseover', handleNodeHover)
    .on('mousemove', e => { tooltip.style.left = e.pageX + 14 + 'px'; tooltip.style.top = e.pageY - 14 + 'px'; })
    .on('mouseout', handleNodeOut)
    .on('click', (e, d) => { e.stopPropagation(); selectNode(d.id); })
    .call(d3.drag()
      .on('start', (e, d) => { if (!e.active) simulation.alphaTarget(0.3).restart(); d.fx = d.x; d.fy = d.y; })
      .on('drag', (e, d) => { d.fx = e.x; d.fy = e.y; })
      .on('end', (e, d) => { if (!e.active) simulation.alphaTarget(0); d.fx = null; d.fy = null; })
    );

  // Labels
  labelEls = g.append('g')
    .selectAll('text')
    .data(data.nodes)
    .join('text')
    .text(d => d.id)
    .attr('font-family', 'Outfit, sans-serif')
    .attr('font-size', 11)
    .attr('font-weight', 500)
    .attr('fill', '#5a6880')
    .attr('dx', d => radius(d) + 6)
    .attr('dy', 4)
    .style('pointer-events', 'none')
    .attr('opacity', animate ? 0 : 0.8);

  // Entry animation
  if (animate) {
    nodeEls.transition()
      .delay((d, i) => i * 25)
      .duration(500)
      .ease(d3.easeBackOut.overshoot(1.2))
      .attr('r', d => radius(d))
      .attr('opacity', 1);

    linkEls.transition().delay(400).duration(600).attr('opacity', 0.2);
    labelEls.transition().delay(600).duration(400).attr('opacity', 0.8);
  }

  // Highlight new/updated nodes
  if (newNodeIds.size || updatedNodeIds.size) {
    nodeEls.filter(d => newNodeIds.has(d.id))
      .attr('r', 0).attr('opacity', 0)
      .transition().duration(700).ease(d3.easeElasticOut)
      .attr('r', d => radius(d) * 1.4)
      .attr('opacity', 1)
      .transition().duration(300)
      .attr('r', d => radius(d));

    nodeEls.filter(d => updatedNodeIds.has(d.id))
      .transition().duration(200).attr('stroke-width', 4).attr('stroke-opacity', 0.8)
      .transition().delay(1500).duration(500).attr('stroke-width', 1.5).attr('stroke-opacity', 0.25);

    haloEls.filter(d => newNodeIds.has(d.id) || updatedNodeIds.has(d.id))
      .attr('opacity', 0.3)
      .transition().duration(1500)
      .attr('r', d => radius(d) + 30)
      .attr('opacity', 0);
  }

  // Tick
  simulation.on('tick', () => {
    linkEls.attr('x1', d => d.source.x).attr('y1', d => d.source.y)
           .attr('x2', d => d.target.x).attr('y2', d => d.target.y);
    nodeEls.attr('cx', d => d.x).attr('cy', d => d.y);
    haloEls.attr('cx', d => d.x).attr('cy', d => d.y);
    labelEls.attr('x', d => d.x).attr('y', d => d.y);
  });

  // Click background to deselect
  svg.on('click', () => {
    selectedNode = null;
    resetHighlight();
    document.getElementById('node-detail').style.display = 'none';
    document.getElementById('explore-empty').style.display = 'flex';
  });
}

function handleNodeHover(event, d) {
  tooltip.textContent = d.id + (d.type ? ` (${d.type})` : '');
  tooltip.classList.add('visible');
  tooltip.style.left = event.pageX + 14 + 'px';
  tooltip.style.top = event.pageY - 14 + 'px';
  highlightConnections(d);
}

function handleNodeOut() {
  tooltip.classList.remove('visible');
  if (!selectedNode) resetHighlight();
}

function highlightConnections(d) {
  const connected = new Set([d.id]);
  graphData.links.forEach(l => {
    const sid = l.source.id || l.source;
    const tid = l.target.id || l.target;
    if (sid === d.id) connected.add(tid);
    if (tid === d.id) connected.add(sid);
  });

  nodeEls.transition().duration(150)
    .attr('opacity', n => connected.has(n.id) ? 1 : 0.08);
  labelEls.transition().duration(150)
    .attr('opacity', n => connected.has(n.id) ? 1 : 0.03);
  linkEls.transition().duration(150)
    .attr('opacity', l => (l.source.id === d.id || l.target.id === d.id) ? 0.7 : 0.02)
    .attr('stroke', l => (l.source.id === d.id || l.target.id === d.id) ? color(d.type) : '#0d1a30')
    .attr('stroke-width', l => (l.source.id === d.id || l.target.id === d.id) ? 2 : 1.2);
}

function resetHighlight() {
  nodeEls.transition().duration(200).attr('opacity', 1);
  labelEls.transition().duration(200).attr('opacity', 0.8);
  linkEls.transition().duration(200).attr('opacity', 0.2).attr('stroke', '#0d1a30').attr('stroke-width', 1.2);
}

function highlightNodeSet(names) {
  highlightedNodes = new Set(names);
  nodeEls.transition().duration(200)
    .attr('opacity', n => !names.length || highlightedNodes.has(n.id) ? 1 : 0.1)
    .attr('stroke-width', n => highlightedNodes.has(n.id) ? 3 : 1.5)
    .attr('stroke-opacity', n => highlightedNodes.has(n.id) ? 0.7 : 0.25);
  labelEls.transition().duration(200)
    .attr('opacity', n => !names.length || highlightedNodes.has(n.id) ? 1 : 0.05);
}

// ── Node Selection ──
async function selectNode(name) {
  selectedNode = name;
  // Switch to explore tab
  document.querySelectorAll('.sidebar-tab').forEach(t => t.classList.remove('active'));
  document.querySelectorAll('.tab-panel').forEach(p => p.classList.remove('active'));
  document.querySelector('[data-tab="explore"]').classList.add('active');
  document.getElementById('tab-explore').classList.add('active');

  const resp = await fetch(`/api/node/${encodeURIComponent(name)}`);
  const node = await resp.json();
  if (node.error) return;

  const c = color(node.type);
  const contentHtml = renderWikilinks(escapeHtml(node.content));

  document.getElementById('explore-empty').style.display = 'none';
  const detail = document.getElementById('node-detail');
  detail.style.display = 'block';
  detail.innerHTML = `
    <div class="node-detail-header">
      <div class="node-detail-name">${escapeHtml(node.name)}</div>
      <span class="node-type-badge" style="background:${c}18;color:${c};border:1px solid ${c}30">${node.type}</span>
      ${node.tags.length ? `<div class="node-tags">${node.tags.map(t => `<span class="node-tag">${escapeHtml(t)}</span>`).join('')}</div>` : ''}
    </div>
    <div class="node-content">${contentHtml}</div>
    ${node.outlinks.length ? `
      <div class="links-section">
        <div class="links-label">Links to</div>
        <div class="links-list">${node.outlinks.map(l => `<span class="link-chip" onclick="selectNode('${l}')">${l}</span>`).join('')}</div>
      </div>` : ''}
    ${node.backlinks.length ? `
      <div class="links-section">
        <div class="links-label">Referenced by</div>
        <div class="links-list">${node.backlinks.map(l => `<span class="link-chip" onclick="selectNode('${l}')">${l}</span>`).join('')}</div>
      </div>` : ''}
    <div class="node-meta">Created ${node.created} &middot; Updated ${node.updated}</div>
  `;

  // Highlight this node and its connections on the graph
  const d = graphData.nodes.find(n => n.id === name);
  if (d) highlightConnections(d);
  setStatus(`Exploring <span class="highlight">${name}</span>`);
}

// ── Query ──
async function submitQuery() {
  const input = document.getElementById('ask-input');
  const question = input.value.trim();
  if (!question) return;

  document.getElementById('ask-submit').disabled = true;
  document.getElementById('ask-loading').style.display = 'block';
  document.getElementById('ask-answer').innerHTML = '';
  setStatus(`Querying as <span class="highlight">${activeRole}</span>...`);

  try {
    const resp = await fetch('/api/query', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ question, role: activeRole }),
    });
    const data = await resp.json();
    const answerHtml = renderWikilinks(escapeHtml(data.answer));
    document.getElementById('ask-answer').innerHTML = answerHtml;

    // Extract and highlight referenced nodes
    const refs = [...data.answer.matchAll(/\[\[([^\]]+)\]\]/g)].map(m => m[1]);
    if (refs.length) highlightNodeSet(refs);

    setStatus(`Query complete — <span class="highlight">${refs.length} nodes</span> referenced`);
  } catch (e) {
    document.getElementById('ask-answer').innerHTML = `<span style="color:var(--danger)">Error: ${e.message}</span>`;
  } finally {
    document.getElementById('ask-submit').disabled = false;
    document.getElementById('ask-loading').style.display = 'none';
  }
}

// ── Ingest ──
async function submitIngest() {
  const input = document.getElementById('ingest-input');
  const content = input.value.trim();
  if (!content) return;

  document.getElementById('ingest-submit').disabled = true;
  document.getElementById('ingest-loading').style.display = 'block';
  document.getElementById('ingest-result').innerHTML = '';
  setStatus('AI is analyzing the event...');

  try {
    const resp = await fetch('/api/ingest', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ content }),
    });
    const data = await resp.json();

    const createdHtml = data.nodes_created.length
      ? `<div><span class="created">Created:</span> ${data.nodes_created.join(', ')}</div>` : '';
    const updatedHtml = data.nodes_updated.length
      ? `<div><span class="updated">Updated:</span> ${data.nodes_updated.join(', ')}</div>` : '';
    document.getElementById('ingest-result').innerHTML =
      `${createdHtml}${updatedHtml}<div style="margin-top:8px">${escapeHtml(data.summary)}</div>`;

    // Re-render graph with animation for new/updated nodes
    renderGraph(data.graph, {
      animate: false,
      newNodes: data.nodes_created,
      updatedNodes: data.nodes_updated,
    });

    setStatus(`Ingested — <span class="highlight">${data.nodes_created.length} created</span>, ${data.nodes_updated.length} updated`);
    input.value = '';
  } catch (e) {
    document.getElementById('ingest-result').innerHTML = `<span style="color:var(--danger)">Error: ${e.message}</span>`;
  } finally {
    document.getElementById('ingest-submit').disabled = false;
    document.getElementById('ingest-loading').style.display = 'none';
  }
}

// ── Demo Scenarios ──
const SCENARIOS = {
  'ceo-status': { role: 'ceo', question: 'Give me a complete status update. What changed recently? What are the key risks? What needs my attention?' },
  'onboard': { role: 'new-joiner', question: "I just joined the company as an engineer. Bring me up to speed on everything — the teams, the projects, the key decisions, and what's happening right now." },
  'conflict': { role: 'pm', question: 'Are there any contradictory or conflicting pieces of information in the system? Any dates that changed, decisions that were revised, or conflicting statements from different people?' },
  'dependency': { role: 'engineer', question: 'Map out all the dependencies and blockers for the Q2 product launch. What has to happen in what order? What are the critical path items?' },
};

function runScenario(key) {
  const s = SCENARIOS[key];
  document.getElementById('ask-input').value = s.question;
  document.querySelectorAll('.role-chip').forEach(c => {
    c.classList.toggle('active', c.dataset.role === s.role);
  });
  activeRole = s.role;
  // Switch to ask tab
  document.querySelectorAll('.sidebar-tab').forEach(t => t.classList.remove('active'));
  document.querySelectorAll('.tab-panel').forEach(p => p.classList.remove('active'));
  document.querySelector('[data-tab="ask"]').classList.add('active');
  document.getElementById('tab-ask').classList.add('active');
  submitQuery();
}

// ── Sample Events ──
const SAMPLES = {
  security: `Security Review Meeting — Feb 7

Attendees: Marcus, Lisa, external auditor (CyberShield Inc.)

Findings from the penetration test of the new JWT authentication system:
- No critical vulnerabilities found
- RS256 implementation is sound
- Recommendation: reduce key rotation period from 90 days to 60 days
- Minor finding: error messages in auth endpoints leak internal service names (low severity)
- The Redis token blocklist has a TTL mismatch — tokens can remain on the blocklist 2 hours longer than needed

Action items:
- Alice → fix error message information leakage by Feb 10
- Kai → fix Redis TTL alignment by Feb 10
- Marcus → update key rotation schedule per recommendation`,

  hire: `Slack #general — Feb 7

@channel: Excited to announce that Mira Patel is joining the Data team next Monday! She's coming from Google Brain with deep expertise in transformer architectures and production ML systems. She'll be working on the ML Pipeline v2 inference optimization.

@priya: Welcome Mira! I'll set up your onboarding schedule this week. You'll be pairing with James on the inference API first.

@james: Looking forward to it! We could really use your expertise on model serving at scale.`,

  incident: `INCIDENT REPORT — Feb 7 10:42 UTC

Severity: P2
Service: product-api
Duration: 12 minutes

What happened: product-api authentication started returning 401 errors for ~15% of requests. Root cause: during the auth migration Phase 2 prep work, a configuration change was deployed to staging that accidentally also went to production.

Timeline:
- 10:42 — Alerts fire for elevated 401 rates
- 10:44 — Bob identifies the config change
- 10:48 — Marcus rolls back the configuration
- 10:54 — All services healthy

Impact: ~800 failed API requests. No data loss.
Action items:
- Add deployment safeguard to prevent staging configs from reaching production
- Marcus to review the deployment pipeline for Phase 2`
};

function loadSample(key) {
  document.getElementById('ingest-input').value = SAMPLES[key];
  // Switch to ingest tab
  document.querySelectorAll('.sidebar-tab').forEach(t => t.classList.remove('active'));
  document.querySelectorAll('.tab-panel').forEach(p => p.classList.remove('active'));
  document.querySelector('[data-tab="ingest"]').classList.add('active');
  document.getElementById('tab-ingest').classList.add('active');
}

// ── Zoom Controls ──
function zoomIn() {
  d3.select('#graph-svg').transition().duration(300).call(zoomBehavior.scaleBy, 1.3);
}
function zoomOut() {
  d3.select('#graph-svg').transition().duration(300).call(zoomBehavior.scaleBy, 0.7);
}
function resetZoom() {
  const rect = document.querySelector('.graph-area').getBoundingClientRect();
  d3.select('#graph-svg').transition().duration(500)
    .call(zoomBehavior.transform,
      d3.zoomIdentity.translate(rect.width / 2, rect.height / 2).scale(0.85).translate(-rect.width / 2, -rect.height / 2));
}

// ── Helpers ──
function escapeHtml(str) {
  return str.replace(/&/g, '&amp;').replace(/</g, '&lt;').replace(/>/g, '&gt;').replace(/"/g, '&quot;');
}

function renderWikilinks(html) {
  return html.replace(
    /\[\[([^\]]+)\]\]/g,
    '<span class="wikilink" onclick="selectNode(\'$1\')">$1</span>'
  );
}

function setStatus(html) {
  document.getElementById('statusbar').innerHTML = html;
}

// ── Ask on Enter ──
document.getElementById('ask-input').addEventListener('keydown', e => {
  if (e.key === 'Enter' && !e.shiftKey) { e.preventDefault(); submitQuery(); }
});

// ── Init ──
fetch('/api/graph')
  .then(r => r.json())
  .then(data => renderGraph(data, { animate: true }))
  .catch(e => setStatus(`<span style="color:var(--danger)">Failed to load graph: ${e.message}</span>`));
</script>
</body>
</html>
